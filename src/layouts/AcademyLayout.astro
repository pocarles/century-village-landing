---
import BaseLayout from './BaseLayout.astro';
import type { CollectionEntry } from 'astro:content';

interface Props {
  entry: CollectionEntry<'academy'>;
  relatedArticles?: CollectionEntry<'academy'>[];
}

const { entry, relatedArticles = [] } = Astro.props;
const { title, description, pubDate, author, tags, category } = entry.data;

const formattedDate = new Intl.DateTimeFormat('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
}).format(pubDate);

const readingTime = Math.ceil(entry.body.split(' ').length / 200); // Assume 200 words per minute

// Generate table of contents from headings
const headings = entry.body.match(/^##\s+(.+)$/gm)?.map(h => {
  const text = h.replace(/^##\s+/, '');
  const id = text.toLowerCase().replace(/[^a-z0-9]+/g, '-');
  return { text, id };
}) || [];

// JSON-LD for Article
const articleSchema = {
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": title,
  "description": description,
  "datePublished": pubDate.toISOString(),
  "dateModified": pubDate.toISOString(),
  "author": {
    "@type": "Organization",
    "name": author
  },
  "publisher": {
    "@type": "Organization",
    "name": "CenturySync",
    "logo": {
      "@type": "ImageObject",
      "url": "https://centurysync.com/logo.png"
    }
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": Astro.url.href
  },
  "keywords": tags.join(', ')
};

const shareUrl = encodeURIComponent(Astro.url.href);
const shareTitle = encodeURIComponent(title);
---

<BaseLayout title={title} description={description}>
  <!-- JSON-LD structured data -->
  <script type="application/ld+json" set:html={JSON.stringify(articleSchema)} />

  <article class="section-padding bg-gradient-to-b from-white via-gray-50 to-white">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <!-- Breadcrumb -->
      <nav class="mb-8 reveal">
        <ol class="flex items-center space-x-2 text-sm text-gray-500">
          <li><a href="/" class="hover:text-primary-600 transition-colors">Home</a></li>
          <li><span class="mx-2">/</span></li>
          <li><a href="/academy" class="hover:text-primary-600 transition-colors">Academy</a></li>
          <li><span class="mx-2">/</span></li>
          <li class="text-gray-900 truncate max-w-xs">{title}</li>
        </ol>
      </nav>

      {entry.data.image && (
        <div class="mb-12 reveal">
          <img
            src={entry.data.image}
            alt={title}
            class="w-full rounded-3xl shadow-stripe-lg"
            loading="eager"
          />
        </div>
      )}

      <div class="grid grid-cols-1 lg:grid-cols-12 gap-12">
        <!-- Main Content -->
        <div class="lg:col-span-8">
          <!-- Article Header -->
          <header class="mb-12 reveal">
            <div class="flex items-center space-x-3 mb-4">
              <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-primary-100 text-primary-700">
                {category}
              </span>
              <span class="text-sm text-gray-500">{readingTime} min read</span>
            </div>

            <h1 class="text-heading-1 sm:text-heading-1-sm mb-6 text-balance">
              {title}
            </h1>

            <p class="text-body-lg text-gray-600 mb-6">
              {description}
            </p>

            <div class="flex items-center justify-between pb-6 border-b border-gray-200">
              <div class="flex items-center space-x-4">
                <div>
                  <p class="text-sm font-semibold text-gray-900">{author}</p>
                  <p class="text-sm text-gray-500">
                    <time datetime={pubDate.toISOString()}>{formattedDate}</time>
                  </p>
                </div>
              </div>

              <!-- Share Buttons -->
              <div class="flex items-center space-x-2">
                <span class="text-sm text-gray-500 mr-2">Share:</span>
                <a
                  href={`https://twitter.com/intent/tweet?url=${shareUrl}&text=${shareTitle}`}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="p-2 rounded-full hover:bg-gray-100 transition-colors"
                  aria-label="Share on Twitter"
                >
                  <svg class="w-5 h-5 text-gray-600" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                  </svg>
                </a>
                <a
                  href={`https://www.facebook.com/sharer/sharer.php?u=${shareUrl}`}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="p-2 rounded-full hover:bg-gray-100 transition-colors"
                  aria-label="Share on Facebook"
                >
                  <svg class="w-5 h-5 text-gray-600" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                  </svg>
                </a>
                <a
                  href={`https://www.linkedin.com/sharing/share-offsite/?url=${shareUrl}`}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="p-2 rounded-full hover:bg-gray-100 transition-colors"
                  aria-label="Share on LinkedIn"
                >
                  <svg class="w-5 h-5 text-gray-600" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M20.5 2h-17A1.5 1.5 0 002 3.5v17A1.5 1.5 0 003.5 22h17a1.5 1.5 0 001.5-1.5v-17A1.5 1.5 0 0020.5 2zM8 19H5v-9h3zM6.5 8.25A1.75 1.75 0 118.3 6.5a1.78 1.78 0 01-1.8 1.75zM19 19h-3v-4.74c0-1.42-.6-1.93-1.38-1.93A1.74 1.74 0 0013 14.19a.66.66 0 000 .14V19h-3v-9h2.9v1.3a3.11 3.11 0 012.7-1.4c1.55 0 3.36.86 3.36 3.66z"/>
                  </svg>
                </a>
                <button
                  id="copy-link-btn"
                  class="p-2 rounded-full hover:bg-gray-100 transition-colors"
                  aria-label="Copy link"
                >
                  <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                  </svg>
                </button>
              </div>
            </div>
          </header>

          <!-- Article Content -->
          <div class="prose prose-lg max-w-none reveal
            prose-headings:font-bold prose-headings:tracking-tight
            prose-h2:text-2xl prose-h2:mt-12 prose-h2:mb-4
            prose-h3:text-xl prose-h3:mt-8 prose-h3:mb-3
            prose-p:text-gray-700 prose-p:leading-relaxed
            prose-a:text-primary-600 prose-a:no-underline hover:prose-a:underline
            prose-strong:text-gray-900 prose-strong:font-semibold
            prose-ul:my-6 prose-li:my-2
            prose-code:text-primary-700 prose-code:bg-primary-50 prose-code:px-1 prose-code:py-0.5 prose-code:rounded prose-code:font-medium
            prose-pre:bg-primary-50 prose-pre:text-gray-800 prose-pre:border prose-pre:border-primary-200 prose-pre:rounded-xl
            prose-blockquote:border-l-4 prose-blockquote:border-primary-500 prose-blockquote:pl-4 prose-blockquote:italic
          ">
            <slot />
          </div>

          <!-- Tags -->
          {tags.length > 0 && (
            <div class="mt-12 pt-8 border-t border-gray-200 reveal">
              <div class="flex flex-wrap gap-2">
                <span class="text-sm font-semibold text-gray-700">Tags:</span>
                {tags.map(tag => (
                  <a
                    href={`/academy?tag=${encodeURIComponent(tag)}`}
                    class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-gray-100 text-gray-700 hover:bg-primary-100 hover:text-primary-700 transition-colors"
                  >
                    {tag}
                  </a>
                ))}
              </div>
            </div>
          )}

          <!-- Related Articles -->
          {relatedArticles.length > 0 && (
            <div class="mt-16 pt-12 border-t border-gray-200 reveal">
              <h2 class="text-heading-3 mb-8">Related Articles</h2>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                {relatedArticles.map(article => (
                  <a
                    href={`/academy/${article.slug}`}
                    class="group p-6 rounded-2xl border border-gray-200 hover:border-primary-300 hover:shadow-stripe-md transition-all"
                  >
                    <div class="flex items-center space-x-2 mb-3">
                      <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-primary-100 text-primary-700">
                        {article.data.category}
                      </span>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 group-hover:text-primary-600 transition-colors mb-2">
                      {article.data.title}
                    </h3>
                    <p class="text-sm text-gray-600 line-clamp-2">
                      {article.data.description}
                    </p>
                  </a>
                ))}
              </div>
            </div>
          )}

          <!-- CTA -->
          <div class="mt-16 p-8 rounded-3xl bg-gradient-to-br from-primary-50 to-accent-100 reveal">
            <div class="max-w-2xl">
              <h3 class="text-heading-3 mb-3">Ready to Simplify Your Association Management?</h3>
              <p class="text-body text-gray-700 mb-6">
                CenturySync provides the tools you need to manage documents, communicate with owners, and stay compliant with Florida law.
              </p>
              <div class="flex flex-col sm:flex-row gap-4">
                <a
                  href="/#demo"
                  class="inline-flex items-center justify-center px-6 py-3 bg-primary-600 text-white font-semibold rounded-full hover:bg-primary-700 transition-all duration-150 ease-stripe btn-shine shadow-stripe-sm hover:shadow-stripe-md"
                >
                  Schedule a Demo
                </a>
                <a
                  href="/academy"
                  class="inline-flex items-center justify-center px-6 py-3 bg-white text-gray-700 font-semibold rounded-full border border-gray-200 hover:bg-gray-50 hover:border-gray-300 transition-all duration-150 ease-stripe shadow-stripe-xs"
                >
                  More Articles
                </a>
              </div>
            </div>
          </div>
        </div>

        <!-- Sidebar -->
        <aside class="lg:col-span-4">
          <div class="space-y-8">
            <!-- Table of Contents -->
            {headings.length > 0 && (
              <div class="p-6 rounded-2xl bg-gray-50 border border-gray-200 reveal">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Table of Contents</h3>
                <nav class="space-y-2">
                  {headings.map(heading => (
                    <a
                      href={`#${heading.id}`}
                      class="block text-sm text-gray-600 hover:text-primary-600 transition-colors py-1"
                    >
                      {heading.text}
                    </a>
                  ))}
                </nav>
              </div>
            )}

            <!-- Newsletter Signup -->
            <div class="p-6 rounded-2xl bg-primary-600 text-white reveal">
              <h3 class="text-lg font-semibold mb-3">Stay Updated</h3>
              <p class="text-sm text-primary-100 mb-4">
                Get new articles and compliance updates delivered to your inbox.
              </p>
              <form id="academy-newsletter-form" class="space-y-3">
                <input
                  type="text"
                  id="academy-firstName"
                  name="firstName"
                  placeholder="First name"
                  required
                  class="w-full px-4 py-2 rounded-lg text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-white text-sm"
                />
                <input
                  type="text"
                  id="academy-lastName"
                  name="lastName"
                  placeholder="Last name"
                  required
                  class="w-full px-4 py-2 rounded-lg text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-white text-sm"
                />
                <input
                  type="email"
                  id="academy-email"
                  name="email"
                  placeholder="your@email.com"
                  required
                  class="w-full px-4 py-2 rounded-lg text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-white text-sm"
                />
                <button
                  type="submit"
                  id="academy-subscribe-btn"
                  class="w-full px-4 py-2 bg-white text-primary-600 font-semibold rounded-lg hover:bg-primary-50 transition-colors disabled:opacity-50"
                >
                  <span id="academy-btn-text">Subscribe</span>
                  <svg id="academy-btn-spinner" class="hidden w-5 h-5 mx-auto animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                </button>
                <div id="academy-success" class="hidden text-xs text-white bg-white/20 rounded px-3 py-2">
                  âœ“ Subscribed! Check your email.
                </div>
                <div id="academy-error" class="hidden text-xs text-white bg-red-500/30 rounded px-3 py-2">
                  Error. Please try again.
                </div>
              </form>
              <div class="mt-4 pt-4 border-t border-white/20">
                <a href="/academy/rss.xml" class="text-xs text-primary-100 hover:text-white flex items-center gap-1">
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M5 3a1 1 0 000 2c5.523 0 10 4.477 10 10a1 1 0 102 0C17 8.373 11.627 3 5 3z"/>
                    <path d="M4 9a1 1 0 011-1 7 7 0 017 7 1 1 0 11-2 0 5 5 0 00-5-5 1 1 0 01-1-1zM3 15a2 2 0 114 0 2 2 0 01-4 0z"/>
                  </svg>
                  Or subscribe via RSS
                </a>
              </div>
            </div>
            
            <script is:inline>
              document.getElementById('academy-newsletter-form')?.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const form = e.target;
                const btn = document.getElementById('academy-subscribe-btn');
                const btnText = document.getElementById('academy-btn-text');
                const spinner = document.getElementById('academy-btn-spinner');
                const success = document.getElementById('academy-success');
                const error = document.getElementById('academy-error');
                
                success.classList.add('hidden');
                error.classList.add('hidden');
                btn.disabled = true;
                btnText.classList.add('hidden');
                spinner.classList.remove('hidden');
                
                try {
                  const response = await fetch('https://nextgen.pocarles.com/webhook/centurysync-form', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                      firstName: form.firstName.value,
                      lastName: form.lastName.value,
                      email: form.email.value,
                      source: 'centurysync-academy',
                      subscribedTo: 'academy-updates',
                      submittedAt: new Date().toISOString()
                    })
                  });
                  
                  if (response.ok) {
                    success.classList.remove('hidden');
                    form.reset();
                  } else {
                    throw new Error('Server error');
                  }
                } catch (err) {
                  console.error('Subscription error:', err);
                  error.classList.remove('hidden');
                } finally {
                  btn.disabled = false;
                  btnText.classList.remove('hidden');
                  spinner.classList.add('hidden');
                }
              });
            </script>

            <!-- Contact CTA -->
            <div class="p-6 rounded-2xl border-2 border-primary-200 bg-primary-50 reveal">
              <h3 class="text-lg font-semibold text-gray-900 mb-2">Need Help?</h3>
              <p class="text-sm text-gray-700 mb-4">
                Visit our office hours every Wednesday, 2-5 PM at Century Village.
              </p>
              <p class="text-sm font-semibold text-primary-600">
                100-110 Century Blvd, Suite 202
              </p>
            </div>
          </div>
        </aside>
      </div>
    </div>
  </article>

  <script>
    // Copy link button
    const copyBtn = document.getElementById('copy-link-btn');
    if (copyBtn) {
      copyBtn.addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(window.location.href);
          const svg = copyBtn.querySelector('svg');
          if (svg) {
            svg.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>';
            setTimeout(() => {
              svg.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>';
            }, 2000);
          }
        } catch (err) {
          console.error('Failed to copy link:', err);
        }
      });
    }

    // Smooth scroll for TOC links
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
      anchor.addEventListener('click', function (e) {
        e.preventDefault();
        const targetId = this.getAttribute('href');
        if (targetId && targetId !== '#') {
          const target = document.querySelector(targetId);
          if (target) {
            target.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
        }
      });
    });
  </script>
</BaseLayout>
