---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

// Get all academy articles
const allArticles = await getCollection('academy');

// Sort by date (newest first)
const sortedArticles = allArticles.sort((a, b) => 
  b.data.pubDate.getTime() - a.data.pubDate.getTime()
);

// Featured articles
const featuredArticles = sortedArticles.filter(article => article.data.featured);

// Get unique categories and tags
const categories = [...new Set(allArticles.map(a => a.data.category))].sort();
const allTags = [...new Set(allArticles.flatMap(a => a.data.tags))].sort();

// Format date helper
const formatDate = (date: Date) => {
  return new Intl.DateTimeFormat('en-US', {
    year: 'numeric',
    month: 'short',
    day: 'numeric'
  }).format(date);
};
---

<BaseLayout
  title="CenturySync Academy"
  description="Educational resources, compliance guides, and best practices for Florida condominium association boards. Learn about HB 1021, document management, board communication, and more."
>
  <!-- Hero Section -->
  <section class="relative overflow-hidden bg-gradient-to-br from-primary-50 via-white to-accent-100 pt-32 pb-20">
    <div class="absolute inset-0 bg-dot-pattern opacity-30"></div>
    
    <div class="relative max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-center max-w-3xl mx-auto reveal">
        <div class="inline-flex items-center px-4 py-2 rounded-full bg-primary-100 text-primary-700 font-semibold text-sm mb-6">
          ðŸ“š Educational Resources
        </div>
        
        <h1 class="text-display sm:text-display-sm mb-6 text-balance">
          <span class="gradient-text">CenturySync Academy</span>
        </h1>
        
        <p class="text-body-lg text-gray-600 mb-8 max-w-2xl mx-auto">
          Practical guides and expert insights to help Florida COA boards navigate compliance, 
          communication, and management challenges with confidence.
        </p>

        <!-- Search Bar -->
        <div class="max-w-2xl mx-auto mb-4">
          <div class="relative">
            <input
              type="text"
              id="academy-search"
              placeholder="Search articles..."
              class="w-full px-6 py-4 pr-12 rounded-2xl border-2 border-gray-200 bg-white text-gray-900 placeholder-gray-400 
                     focus:border-primary-500 focus:outline-none transition-all shadow-stripe-sm focus:shadow-stripe-md"
            />
            <svg class="absolute right-4 top-1/2 -translate-y-1/2 w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
          </div>
          <div id="search-results" class="hidden mt-4 p-6 rounded-2xl bg-white shadow-stripe-lg border border-gray-200">
            <div id="search-results-content"></div>
          </div>
        </div>

        <!-- Quick stats -->
        <div class="flex justify-center items-center space-x-8 text-sm text-gray-600">
          <div class="flex items-center space-x-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
            <span>{allArticles.length} Articles</span>
          </div>
          <div class="flex items-center space-x-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
            </svg>
            <span>{categories.length} Categories</span>
          </div>
          <div class="flex items-center space-x-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <span>Updated Weekly</span>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Category Filter -->
  <section class="py-8 bg-white border-b border-gray-200 sticky top-0 z-40 shadow-sm">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-2 overflow-x-auto scrollbar-hide">
          <button
            data-category="all"
            class="category-filter-btn px-4 py-2 rounded-full font-semibold text-sm whitespace-nowrap transition-all active"
          >
            All Articles
          </button>
          {categories.map(category => (
            <button
              data-category={category}
              class="category-filter-btn px-4 py-2 rounded-full font-semibold text-sm whitespace-nowrap transition-all"
            >
              {category}
            </button>
          ))}
        </div>
        
        <div class="hidden lg:flex items-center space-x-2 text-sm text-gray-600">
          <span>Sort:</span>
          <select
            id="sort-select"
            class="px-3 py-1 rounded-lg border border-gray-200 bg-white focus:outline-none focus:ring-2 focus:ring-primary-500"
          >
            <option value="newest">Newest First</option>
            <option value="oldest">Oldest First</option>
            <option value="title">Alphabetical</option>
          </select>
        </div>
      </div>
    </div>
  </section>

  <!-- Featured Articles -->
  {featuredArticles.length > 0 && (
    <section class="section-padding bg-gray-50">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center mb-12 reveal">
          <h2 class="text-heading-2 sm:text-heading-2-sm mb-4">Featured Articles</h2>
          <p class="text-body text-gray-600 max-w-2xl mx-auto">
            Essential reading for Florida COA board members
          </p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 reveal-stagger">
          {featuredArticles.slice(0, 3).map(article => (
            <article class="group reveal card-hover bg-white rounded-2xl shadow-stripe border border-gray-200 overflow-hidden">
              <div class="p-8">
                <div class="flex items-center space-x-2 mb-4">
                  <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-primary-100 text-primary-700">
                    {article.data.category}
                  </span>
                  <span class="text-xs text-gray-500">{formatDate(article.data.pubDate)}</span>
                </div>
                
                <h3 class="text-xl font-bold text-gray-900 mb-3 group-hover:text-primary-600 transition-colors">
                  <a href={`/academy/${article.slug}`} class="hover:underline">
                    {article.data.title}
                  </a>
                </h3>
                
                <p class="text-body-sm text-gray-600 mb-4 line-clamp-3">
                  {article.data.description}
                </p>
                
                <div class="flex items-center justify-between">
                  <a
                    href={`/academy/${article.slug}`}
                    class="inline-flex items-center text-sm font-semibold text-primary-600 hover:text-primary-700"
                  >
                    Read Article
                    <svg class="w-4 h-4 ml-1 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                  </a>
                  
                  {article.data.tags.length > 0 && (
                    <div class="flex items-center space-x-1">
                      {article.data.tags.slice(0, 2).map(tag => (
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs bg-gray-100 text-gray-600">
                          {tag}
                        </span>
                      ))}
                    </div>
                  )}
                </div>
              </div>
            </article>
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- All Articles Grid -->
  <section class="section-padding">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between mb-12 reveal">
        <h2 class="text-heading-2 sm:text-heading-2-sm">All Articles</h2>
        <a href="/academy/rss.xml" class="inline-flex items-center text-sm font-semibold text-primary-600 hover:text-primary-700">
          <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24">
            <path d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z"/>
          </svg>
          Subscribe via RSS
        </a>
      </div>

      <div id="articles-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 reveal-stagger">
        {sortedArticles.map(article => (
          <article
            class="article-card group reveal card-hover bg-white rounded-2xl shadow-stripe-sm border border-gray-200 overflow-hidden"
            data-category={article.data.category}
            data-date={article.data.pubDate.getTime()}
            data-title={article.data.title.toLowerCase()}
            data-tags={article.data.tags.join(',')}
          >
            <div class="p-6">
              <div class="flex items-center space-x-2 mb-3">
                <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold bg-primary-100 text-primary-700">
                  {article.data.category}
                </span>
                <span class="text-xs text-gray-500">{formatDate(article.data.pubDate)}</span>
              </div>
              
              <h3 class="text-lg font-bold text-gray-900 mb-2 group-hover:text-primary-600 transition-colors">
                <a href={`/academy/${article.slug}`} class="hover:underline">
                  {article.data.title}
                </a>
              </h3>
              
              <p class="text-sm text-gray-600 mb-4 line-clamp-2">
                {article.data.description}
              </p>
              
              <div class="flex items-center justify-between">
                <span class="text-xs text-gray-500">By {article.data.author}</span>
                
                <a
                  href={`/academy/${article.slug}`}
                  class="inline-flex items-center text-sm font-semibold text-primary-600 hover:text-primary-700"
                >
                  Read More
                  <svg class="w-4 h-4 ml-1 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                  </svg>
                </a>
              </div>
              
              {article.data.tags.length > 0 && (
                <div class="flex flex-wrap gap-1.5 mt-4 pt-4 border-t border-gray-100">
                  {article.data.tags.slice(0, 3).map(tag => (
                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs bg-gray-100 text-gray-600">
                      {tag}
                    </span>
                  ))}
                </div>
              )}
            </div>
          </article>
        ))}
      </div>

      <!-- No results message -->
      <div id="no-results" class="hidden text-center py-16">
        <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-gray-100 mb-4">
          <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
        </div>
        <h3 class="text-xl font-semibold text-gray-900 mb-2">No articles found</h3>
        <p class="text-gray-600 mb-6">Try adjusting your filters or search terms</p>
        <button id="reset-filters" class="px-6 py-2 bg-primary-600 text-white font-semibold rounded-full hover:bg-primary-700 transition-colors">
          Reset Filters
        </button>
      </div>
    </div>
  </section>

  <!-- Newsletter CTA -->
  <section class="section-padding bg-gradient-to-br from-primary-600 to-primary-700">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center reveal">
      <h2 class="text-heading-2 sm:text-heading-2-sm text-white mb-4">
        Stay Updated
      </h2>
      <p class="text-body-lg text-primary-100 mb-8 max-w-2xl mx-auto">
        Get the latest compliance guides, best practices, and educational content delivered to your inbox.
      </p>
      <form class="max-w-md mx-auto flex gap-3">
        <input
          type="email"
          placeholder="your@email.com"
          class="flex-1 px-6 py-3 rounded-full text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-white"
          required
        />
        <button
          type="submit"
          class="px-6 py-3 bg-white text-primary-600 font-semibold rounded-full hover:bg-primary-50 transition-all shadow-stripe-sm"
        >
          Subscribe
        </button>
      </form>
    </div>
  </section>

  <script>
    // Category filtering
    const categoryBtns = document.querySelectorAll('.category-filter-btn');
    const articleCards = document.querySelectorAll('.article-card');
    const articlesGrid = document.getElementById('articles-grid');
    const noResults = document.getElementById('no-results');
    const sortSelect = document.getElementById('sort-select');
    const resetBtn = document.getElementById('reset-filters');

    let currentCategory = 'all';
    let currentSort = 'newest';

    function filterAndSort() {
      let visibleCount = 0;
      const cardsArray = Array.from(articleCards);

      // Filter
      cardsArray.forEach(card => {
        const category = card.getAttribute('data-category');
        if (currentCategory === 'all' || category === currentCategory) {
          card.style.display = 'block';
          visibleCount++;
        } else {
          card.style.display = 'none';
        }
      });

      // Sort visible cards
      const visibleCards = cardsArray.filter(card => card.style.display !== 'none');
      
      visibleCards.sort((a, b) => {
        if (currentSort === 'newest') {
          return parseInt(b.getAttribute('data-date') || '0') - parseInt(a.getAttribute('data-date') || '0');
        } else if (currentSort === 'oldest') {
          return parseInt(a.getAttribute('data-date') || '0') - parseInt(b.getAttribute('data-date') || '0');
        } else if (currentSort === 'title') {
          return (a.getAttribute('data-title') || '').localeCompare(b.getAttribute('data-title') || '');
        }
        return 0;
      });

      // Re-append in sorted order
      visibleCards.forEach(card => {
        articlesGrid?.appendChild(card);
      });

      // Show/hide no results
      if (noResults && articlesGrid) {
        if (visibleCount === 0) {
          articlesGrid.style.display = 'none';
          noResults.classList.remove('hidden');
        } else {
          articlesGrid.style.display = 'grid';
          noResults.classList.add('hidden');
        }
      }
    }

    categoryBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        // Update active state
        categoryBtns.forEach(b => {
          b.classList.remove('active', 'bg-primary-600', 'text-white');
          b.classList.add('bg-gray-100', 'text-gray-600', 'hover:bg-gray-200');
        });
        btn.classList.add('active', 'bg-primary-600', 'text-white');
        btn.classList.remove('bg-gray-100', 'text-gray-600', 'hover:bg-gray-200');

        currentCategory = btn.getAttribute('data-category') || 'all';
        filterAndSort();
      });
    });

    // Initialize first button
    const firstBtn = categoryBtns[0];
    if (firstBtn) {
      firstBtn.classList.add('bg-primary-600', 'text-white');
    }

    if (sortSelect) {
      sortSelect.addEventListener('change', (e) => {
        currentSort = (e.target as HTMLSelectElement).value;
        filterAndSort();
      });
    }

    if (resetBtn) {
      resetBtn.addEventListener('click', () => {
        currentCategory = 'all';
        currentSort = 'newest';
        if (sortSelect) (sortSelect as HTMLSelectElement).value = 'newest';
        categoryBtns.forEach((btn, idx) => {
          if (idx === 0) {
            btn.classList.add('active', 'bg-primary-600', 'text-white');
            btn.classList.remove('bg-gray-100', 'text-gray-600');
          } else {
            btn.classList.remove('active', 'bg-primary-600', 'text-white');
            btn.classList.add('bg-gray-100', 'text-gray-600');
          }
        });
        filterAndSort();
      });
    }

    // Simple client-side search (we'll integrate Pagefind in build step)
    const searchInput = document.getElementById('academy-search');
    const searchResults = document.getElementById('search-results');
    const searchResultsContent = document.getElementById('search-results-content');

    if (searchInput && searchResults && searchResultsContent) {
      let searchTimeout: NodeJS.Timeout;
      
      searchInput.addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        const query = (e.target as HTMLInputElement).value.trim().toLowerCase();
        
        if (query.length < 2) {
          searchResults.classList.add('hidden');
          return;
        }

        searchTimeout = setTimeout(() => {
          // Simple search across titles, descriptions, and tags
          const matches = Array.from(articleCards).filter(card => {
            const title = card.getAttribute('data-title') || '';
            const tags = card.getAttribute('data-tags') || '';
            const description = card.querySelector('p')?.textContent?.toLowerCase() || '';
            
            return title.includes(query) || tags.includes(query) || description.includes(query);
          }).slice(0, 5);

          if (matches.length > 0) {
            searchResultsContent.innerHTML = matches.map(card => {
              const link = card.querySelector('a');
              const title = link?.textContent?.trim() || '';
              const href = link?.getAttribute('href') || '';
              const category = card.getAttribute('data-category') || '';
              
              return `
                <a href="${href}" class="block p-3 hover:bg-gray-50 rounded-lg transition-colors">
                  <div class="flex items-center space-x-2 mb-1">
                    <span class="text-xs font-semibold text-primary-600">${category}</span>
                  </div>
                  <div class="font-semibold text-gray-900">${title}</div>
                </a>
              `;
            }).join('');
            searchResults.classList.remove('hidden');
          } else {
            searchResultsContent.innerHTML = '<p class="text-gray-600 text-center">No results found</p>';
            searchResults.classList.remove('hidden');
          }
        }, 300);
      });

      // Close search results when clicking outside
      document.addEventListener('click', (e) => {
        if (!searchInput.contains(e.target as Node) && !searchResults.contains(e.target as Node)) {
          searchResults.classList.add('hidden');
        }
      });
    }

    // Initial render
    filterAndSort();
  </script>
</BaseLayout>
